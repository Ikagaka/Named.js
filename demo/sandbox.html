<script src="../bower_components/encoding-japanese/encoding.js"></script>
<script src="../bower_components/jszip/dist/jszip.min.js"></script>
<script src="../bower_components/eventemitter2/lib/eventemitter2.js"></script>
<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../bower_components/narloader/NarLoader.js"></script>
<script src="../bower_components/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="../dist/NamedManager.js"></script>
<script>
Promise.all([
  NarLoader.loadFromURL("../nar/origin.nar"),
  NarLoader.loadFromURL("../nar/mobilemaster.nar")
]).then(function(tmp){
  var balloonNDir = tmp[0];
  var shellNDir = tmp[1];
  var balloonDir = balloonNDir.asArrayBuffer();
  var shellDir = shellNDir.getDirectory("shell/master").asArrayBuffer();
  var shell = new NamedManager.Shell(shellDir);
  var shell2 = new NamedManager.Shell(shellDir);
  var shell3 = new NamedManager.Shell(shellDir);
  var balloon = new NamedManager.Balloon(balloonDir);
  var balloon2 = new NamedManager.Balloon(balloonDir);
  var balloon3 = new NamedManager.Balloon(balloonDir);
  return Promise.all([
    shell.load(),
    balloon.load(),
    shell2.load(),
    balloon2.load(),
    shell3.load(),
    balloon3.load()
  ]);
}).then(function(tmp){
  var shell = tmp[0];
  var balloon = tmp[1];
  var shell2 = tmp[2];
  var balloon2 = tmp[3];
  var shell3 = tmp[4];
  var balloon3 = tmp[5];
  var nmdmgr = new NamedManager.NamedManager();
  document.body.appendChild(nmdmgr.element);
  shell2.bindgroup.forEach(function (arr, i){
    arr.forEach(function(_, j){ shell2.bindgroup[i][j] = false});});
  shell3.bindgroup[0][30] = false
  shell3.bindgroup[0][31] = false
  var hwnd = nmdmgr.materialize(shell, balloon);
  var hwnd2 = nmdmgr.materialize(shell2, balloon2);
  var hwnd3 = nmdmgr.materialize(shell3, balloon3);
  var named = nmdmgr.named(hwnd);
  var named2 = nmdmgr.named(hwnd2);
  var named3 = nmdmgr.named(hwnd3);

  console.log(nmdmgr, hwnd, named, shell, balloon);
  console.log(nmdmgr, hwnd2, named2, shell2, balloon2);
  console.log(nmdmgr, hwnd3, named3, shell3, balloon3);

  talk(named);
  talk(named2);
  talk(named3);
});



function wait(ms, callback) {
  return function(ctx) {
    return new Promise(function(resolve) {
      setTimeout((function() {
        if(callback instanceof Function) callback(ctx);
        return resolve(ctx);
      }), ms);
    });
  };
}

function talk(named){
  named.on("mouse", function(ev){ console.log(ev); });
  named.on("select", function(ev){ console.log(ev); });
  named.on("input", function(ev){ console.log(ev); });
  Promise.resolve(named)
  .then(wait(0, function(named) { named.scope(0); }))
  .then(wait(0, function(named) { named.scope().surface(0); }))
  .then(wait(0, function(named) { named.scope().blimp().clear(); }))
  .then(wait(0, function(named) { named.scope(1); }))
  .then(wait(0, function(named) { named.scope().surface(10); }))
  .then(wait(0, function(named) { named.scope().blimp().clear(); }))
  .then(wait(0, function(named) { named.scope(0); }))
  .then(wait(0, function(named) { named.scope().blimp(0); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("H"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("e"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("l"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("l"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("o"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk(","); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("w"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("o"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("r"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("l"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("d"); }))
  .then(wait(80, function(named) { named.scope().blimp().talk("!"); }))
  .then(wait(160, function(named) { named.scope(1); }))
  .then(wait(0, function(named) { named.scope().blimp().anchorBegin("AnchorID"); }))
  .then(wait(0, function(named) { named.scope().blimp().talk("anchor"); }))
  .then(wait(0, function(named) { named.scope().blimp().anchorEnd(); }))
  .then(wait(0, function(named) { named.scope().blimp().br(); }))
  .then(wait(0, function(named) { named.scope().blimp().talk("<" + "script>alert(1);<" + "/script>"); }))
  .then(wait(0, function(named) { named.scope().blimp().br(); }))
  .then(wait(0, function(named) { named.scope().blimp().choice("choice", "ChoceID"); }))
  .then(wait(0, function(named) { named.scope().blimp().br(); }))
  .then(wait(0, function(named) { named.scope().blimp().talk("hi."); }))
  .then(wait(0, function(named) { named.scope().blimp().showWait(); }))
  .then(wait(3000, function(named) { named.scope().blimp().talk("stop wait"); }));
}
</script>
