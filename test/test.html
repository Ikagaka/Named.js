<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/node_modules/encoding-japanese/encoding.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vendor/jszip.min.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vendor/XHRProxy.min.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vendor/WMDescript.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/Nar.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/underscore/underscore-min.js"></script>
<script src="../node_modules/zepto/zepto.min.js"></script>
<script src="../node_modules/ikagaka.shell.js/SurfaceUtil.js"></script>
<script src="../node_modules/ikagaka.shell.js/Surface.js"></script>
<script src="../node_modules/ikagaka.shell.js/Shell.js"></script>
<script src="../node_modules/ikagaka.balloon.js/BalloonSurface.js"></script>
<script src="../node_modules/ikagaka.balloon.js/Balloon.js"></script>
<script src="../node_modules/es6-shim/es6-shim.min.js"></script>
<script src="../Scope.js"></script>
<script src="../Named.js"></script>
<script src="../NamedManager.js"></script>
<script>
Promise.all([
  new Promise(function(resolve, reject){
    var loader = new Nar.Loader();
    loader.loadFromURL("../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vendor/mobilemaster.nar", function(err, nar){
      if(!!err) return reject(err);
      var shell = new Shell(nar.getDirectory(/shell\/master\//));
      shell.load(function(err){
        if(!!err) return reject(err);
        resolve(shell);
      });
    });
  }),
  new Promise(function(resolve, reject){
    var loader = new Nar.Loader();
    loader.loadFromURL("../node_modules/ikagaka.balloon.js/vendor/origin.nar", function(err, nar){
      if(!!err) return reject(err);
      var balloon = new Balloon(nar.directory);
      balloon.load(function(err){
        if(!!err) return reject(err);
        resolve(balloon);
      });
    });
  })
]).then(function(tmp){
  var shell = tmp[0];
  var balloon = tmp[1];
  var nmgr = new NamedManager();
  $(nmgr.element).appendTo("body");
  console.log(nmgr);
  var nid = nmgr.materialize(shell, balloon);
  var named = nmgr.named(nid);
  var nid2 = nmgr.materialize(shell, balloon);
  var named2 = nmgr.named(nid2);
  named.load(function(){
    $(named.element).on("IkagakaSurfaceEvent", function(ev){ console.log(ev.detail); });
    play(named);
    named2.load(function(){
      $(named2.element).on("IkagakaSurfaceEvent", function(ev){ console.log(ev.detail); });
      play(named2);
    });
  });
}).catch(function(err){ console.error(err.stack) });

function play(named){
  named.scope(0);
  setTimeout(function(){
    named.scope().surface(0);
    setTimeout(function(){
      named.scope().blimp().talk("HELLO WORLD!");
      setTimeout(function(){
        named.scope().blimp().anchorBegin("AnchorID");
        setTimeout(function(){
          named.scope().blimp().talk("anchor");
          setTimeout(function(){
            named.scope().blimp().anchorEnd();
            setTimeout(function(){
              named.scope().blimp().br();
              setTimeout(function(){
                named.scope().blimp().talk("<"+"script>alert(1);<"+"/script>");
                setTimeout(function(){
                  named.scope().blimp().br();
                  setTimeout(function(){
                    named.scope().blimp().choice("choice", "ChoceID");
                    setTimeout(function(){
                      named.scope(1)
                      setTimeout(function(){
                        named.scope().surface(10)
                        setTimeout(function(){
                          named.scope().blimp().talk("unok")
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  });
}
</script>
