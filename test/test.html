<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/node_modules/encoding-japanese/encoding.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vendor/jszip.min.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vendor/XHRProxy.min.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vendor/WMDescript.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/Nar.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="../node_modules/ikagaka.shell.js/node_modules/underscore/underscore-min.js"></script>
<script src="../node_modules/zepto/zepto.min.js"></script>
<script src="../node_modules/ikagaka.shell.js/SurfaceUtil.js"></script>
<script src="../node_modules/ikagaka.shell.js/Surface.js"></script>
<script src="../node_modules/ikagaka.shell.js/Shell.js"></script>
<script src="../node_modules/ikagaka.balloon.js/BalloonSurface.js"></script>
<script src="../node_modules/ikagaka.balloon.js/Balloon.js"></script>
<script src="../node_modules/es6-shim/es6-shim.min.js"></script>
<script src="../Scope.js"></script>
<script src="../Named.js"></script>
<script src="../NamedManager.js"></script>
<script>
function loadNar(src){
  return function(){
    return new Promise(function(resolve, reject){
      var loader = new Nar.Loader();
      loader.loadFromURL(src, function(err, nar){
        if(!!err) return reject(err);
        resolve(nar);
      });
    });
  }
}

function getDir(reg){
  return function(nar){
    return new Promise(function(resolve, reject){
      var dic = nar.getDirectory(reg);
      var dir = Object.keys(dic).reduce(function(_dic, path){
        _dic[path] = dic[path].asArrayBuffer();
        return _dic;
      }, {});
      resolve(dir);
    });
  };
}

Promise.all([
  Promise.resolve()
    .then(loadNar("../node_modules/ikagaka.shell.js/node_modules/ikagaka.nar.js/vendor/mobilemaster.nar"))
    .then(getDir(/shell\/master\//))
    .then(function(dir){ return new Shell(dir).load(); }),
  Promise.resolve()
    .then(loadNar("../node_modules/ikagaka.balloon.js/vendor/origin.nar"))
    .then(getDir(/^/))
    .then(function(dir){ return new Balloon(dir).load(); })
]).then(function(tmp){
  console.log(tmp);
  var shell = tmp[0];
  var balloon = tmp[1];

  var nmgr = new NamedManager();
  $(nmgr.element).appendTo("body");

  var nid = nmgr.materialize(shell, balloon);
  var named = nmgr.named(nid);

  var nid2 = nmgr.materialize(shell, balloon);
  var named2 = nmgr.named(nid2);

  addListener(named);
  addListener(named2);

  /*setTimeout(function(){
    nmgr.vanish(nid2);
  }, 10000);*/

  return Promise.all([
    named.load(),
    named2.load()
  ]);
}).then(function(tmp){
  console.log(tmp);
  var named = tmp[0];
  var named2 = tmp[1];
  play(named);
  play(named2);
}).catch(function(err){ console.error(err.stack) });

function addListener(named){
  named.on("mousedown",       function(ev){ console.log(ev); });
  named.on("mousemove",       function(ev){ console.log(ev); });
  named.on("mouseup",         function(ev){ console.log(ev); });
  named.on("mouseclick",      function(ev){ console.log(ev); });
  named.on("mousedblclick",   function(ev){ console.log(ev); });
  named.on("balloonclick",    function(ev){ console.log(ev); });
  named.on("balloondblclick", function(ev){ console.log(ev); });
  named.on("anchorselect",    function(ev){ console.log(ev); });
  named.on("anchorselectex",  function(ev){ console.log(ev); });
  named.on("raise",           function(ev){ console.log(ev); });
  named.on("choiceselectex",  function(ev){ console.log(ev); });
  named.on("choiceselect",    function(ev){ console.log(ev); });
}

function play(named){
  named.scope(0);
  setTimeout(function(){
    named.scope().surface(0);
    setTimeout(function(){
      named.scope().blimp().talk("HELLO WORLD!");
      setTimeout(function(){
        named.scope().blimp().anchorBegin("AnchorID");
        setTimeout(function(){
          named.scope().blimp().talk("anchor");
          setTimeout(function(){
            named.scope().blimp().anchorEnd();
            setTimeout(function(){
              named.scope().blimp().br();
              setTimeout(function(){
                named.scope().blimp().talk("<"+"script>alert(1);<"+"/script>");
                setTimeout(function(){
                  named.scope().blimp().br();
                  setTimeout(function(){
                    named.scope().blimp().choice("choice", "ChoceID");
                    setTimeout(function(){
                      named.scope(1)
                      setTimeout(function(){
                        named.scope().surface(10)
                        setTimeout(function(){
                          named.scope().blimp().talk("unok")
                          setTimeout(function(){
                            named.scope().blimp().showWait()
                            setTimeout(function(){
                              named.scope().blimp().talk("stop wait")
                            }, 3000);
                          });
                        });
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });
  });
}


</script>
